# =============================================================================
# ArgoCD Application: Karpenter Scale Test - Week 12 Task 4
# =============================================================================
# This application deploys the scale test workload to trigger Karpenter
# node provisioning. It's designed for testing and learning purposes.
#
# To test scale-out:
#   1. Push this file to Git (ArgoCD will auto-sync)
#   2. Watch pods: kubectl get pods -n scale-test -w
#   3. Watch nodes: kubectl get nodes -w
#   4. Watch Karpenter: kubectl logs -n kube-system -l app.kubernetes.io/name=karpenter -f
#
# To test scale-down:
#   1. Edit k8s/karpenter/scale-test-deployment.yaml, set replicas: 1
#   2. Push to Git
#   3. Watch Karpenter consolidate/terminate the extra node (~30s after empty)
#
# To clean up:
#   1. Delete this file from Git
#   2. ArgoCD will prune the namespace and all resources
# =============================================================================
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: karpenter-scale-test
  namespace: argocd
  labels:
    app.kubernetes.io/name: karpenter-scale-test
    purpose: testing
    week: "12"
  # Finalizer ensures resources are cleaned up when the Application is deleted
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default

  # Source repository and path
  source:
    repoURL: https://github.com/rhprasad0/aws-devops-lab
    targetRevision: main
    path: k8s/karpenter
    # Only include the scale test deployment, not the CRDs
    directory:
      include: 'scale-test-deployment.yaml'

  # Destination cluster and namespace
  destination:
    server: https://kubernetes.default.svc
    namespace: scale-test

  # Sync policy - automated for immediate feedback during testing
  syncPolicy:
    automated:
      prune: true      # Delete resources removed from Git
      selfHeal: true   # Revert manual changes back to Git state
    syncOptions:
      - CreateNamespace=true  # Auto-create scale-test namespace
      - PrunePropagationPolicy=foreground
    retry:
      limit: 3
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 1m

