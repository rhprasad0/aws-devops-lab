# Kustomization for guestbook application
# This file configures the Kubernetes resources for deployment
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: guestbook

resources:
  - serviceaccount.yaml
  # Week 9: Using Rollout instead of Deployment for canary deployments
  # The Rollout CRD provides progressive delivery with traffic control
  - rollout.yaml
  # - deployment.yaml  # Replaced by rollout.yaml
  - service.yaml
  - ingress.yaml

# ECR image configuration
# Image is updated automatically by CI/CD pipeline after successful Trivy scan
images:
  - name: GUESTBOOK_IMAGE
    newName: 407645373626.dkr.ecr.us-east-1.amazonaws.com/eks-lab/guestbook
    newTag: 71ff1a3c4274f2d0b6dcd7963a737954baf107fe

# ConfigMap with actual AWS resource names from Terraform
# NOTE: disableNameSuffixHash is required for Argo Rollouts because Kustomize
# doesn't know how to update envFrom references in custom resources (CRDs).
# Without this, pods fail with "configmap not found" error.
generatorOptions:
  disableNameSuffixHash: true

configMapGenerator:
  - name: guestbook-config
    literals:
      # Application configuration
      - AWS_REGION=us-east-1
      - DYNAMODB_TABLE_NAME=a2a-guestbook-messages
      - API_KEYS_SECRET_NAME=a2a-guestbook/api-keys
      - RATE_LIMIT_PER_MINUTE=10
      - LOG_LEVEL=INFO
      - PORT=8000
      # OpenTelemetry/X-Ray Configuration (Week 11)
      - OTEL_SERVICE_NAME=guestbook
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://cloudwatch-agent.amazon-cloudwatch:4317
      - OTEL_TRACES_SAMPLER=always_on
      - OTEL_PROPAGATORS=xray,tracecontext,baggage
      - ENVIRONMENT=dev

# Common labels
commonLabels:
  app.kubernetes.io/name: guestbook
  app.kubernetes.io/component: application
  app.kubernetes.io/part-of: eks-lab
