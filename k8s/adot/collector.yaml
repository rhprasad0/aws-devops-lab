apiVersion: v1
kind: ServiceAccount
metadata:
  name: adot-collector
  namespace: opentelemetry-operator-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: adot-collector
rules:
  - apiGroups: [""]
    resources: ["nodes", "nodes/proxy", "services", "endpoints", "pods"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get"]
  - apiGroups: ["networking.k8s.io"]
    resources: ["ingresses"]
    verbs: ["get", "list", "watch"]
  - nonResourceURLs: ["/metrics"]
    verbs: ["get"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: adot-collector
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: adot-collector
subjects:
  - kind: ServiceAccount
    name: adot-collector
    namespace: opentelemetry-operator-system
---
apiVersion: opentelemetry.io/v1alpha1
kind: OpenTelemetryCollector
metadata:
  name: adot-collector
  namespace: opentelemetry-operator-system
spec:
  mode: deployment
  serviceAccount: adot-collector
  config: |
    receivers:
      prometheus:
        config:
          global:
            scrape_interval: 60s
          scrape_configs:
            # Static target to verify collector can scrape at all
            # Using a known guestbook pod IP for testing
            - job_name: 'static-test'
              static_configs:
              - targets: ['10.0.12.23:8000']
                labels:
                  app: 'guestbook-static-test'
            
            # Kubernetes pod discovery with simplified relabeling
            - job_name: 'kubernetes-pods'
              kubernetes_sd_configs:
              - role: pod
              relabel_configs:
              # Keep only pods with prometheus.io/scrape=true
              - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
                action: keep
                regex: true
              # Set metrics path from annotation
              - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
                action: replace
                target_label: __metrics_path__
                regex: (.+)
              # CRITICAL FIX: The __address__ label from pod SD is pod_ip:container_port
              # We need to replace the port with the annotation port if specified
              # First, let's preserve the pod IP by extracting it
              - source_labels: [__address__]
                action: replace
                regex: ([^:]+)(?::\d+)?
                replacement: $1
                target_label: __tmp_pod_ip
              # Now construct the address using pod IP and annotation port
              - source_labels: [__tmp_pod_ip, __meta_kubernetes_pod_annotation_prometheus_io_port]
                action: replace
                regex: (.+);(.+)
                replacement: $1:$2
                target_label: __address__
              # Copy useful labels
              - action: labelmap
                regex: __meta_kubernetes_pod_label_(.+)
              - source_labels: [__meta_kubernetes_namespace]
                action: replace
                target_label: kubernetes_namespace
              - source_labels: [__meta_kubernetes_pod_name]
                action: replace
                target_label: kubernetes_pod_name

    extensions:
      sigv4auth:
        region: "us-east-1"
        service: "aps"

    exporters:
      # Debug exporter to see what's being scraped
      debug:
        verbosity: detailed
        sampling_initial: 5
        sampling_thereafter: 200
      prometheusremotewrite:
        endpoint: "https://aps-workspaces.us-east-1.amazonaws.com/workspaces/ws-9eb9af5e-9081-4cc1-a39e-178834e6bc03/api/v1/remote_write"
        auth:
          authenticator: sigv4auth

    service:
      extensions: [sigv4auth]
      pipelines:
        metrics:
          receivers: [prometheus]
          exporters: [debug, prometheusremotewrite]
